<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brittany's 22nd Birthday Photo Booth</title>
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Allura&family=Alex+Brush&family=Italianno&family=Tangerine:wght@400;700&family=Dancing+Script:wght@400;500;600;700&family=Playfair+Display:wght@100;200;300;400;500;600;700;800;900&family=Cinzel:wght@100;200;300;400;500;600;700;800;900&family=Cormorant+Garamond:wght@100;200;300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Dancing Script', cursive;
            overflow: hidden;
            height: 100vh;
            position: relative;
        }

        .page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .page.active {
            display: flex;
        }

        .background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #d4b895 0%, #c9a876 100%);
            border: 25px solid #3d2817;
            box-sizing: border-box;
        }

        .cowboy-bg {
            position: absolute;
            top: 25px;
            left: 25px;
            width: calc(100% - 50px);
            height: calc(100% - 50px);
            background: url('cowboy.png') center/cover no-repeat;
            opacity: 0.12;
            z-index: 1;
        }

        .main-content {
            position: relative;
            z-index: 3;
            text-align: center;
            color: #3d2817;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: space-evenly;
            align-items: center;
            padding: 40px 0;
        }

        .title {
            text-shadow: 3px 3px 6px rgba(61, 40, 23, 0.3);
            animation: titleGlow 3s ease-in-out infinite alternate;
            display: flex;
            flex-direction: column;
            justify-content: space-evenly;
            align-items: center;
            flex: 1;
            width: 100%;
        }

        @keyframes titleGlow {
            0% { 
                filter: drop-shadow(0 0 10px rgba(61, 40, 23, 0.3));
            }
            100% { 
                filter: drop-shadow(0 0 25px rgba(61, 40, 23, 0.6));
            }
        }

        .brittanys {
            font-family: 'Great Vibes', cursive;
            font-size: 315px;
            font-weight: 400;
            color: #3d2817;
            line-height: 1;
            text-shadow: 
                8px 8px 16px rgba(61, 40, 23, 0.7),
                4px 4px 8px rgba(61, 40, 23, 0.5),
                2px 2px 4px rgba(61, 40, 23, 0.9),
                0 0 30px rgba(139, 115, 85, 0.4);
            transform: rotate(-2deg);
            animation: gentleFloat 4s ease-in-out infinite;
            position: relative;
        }

        .brittanys::before {
            content: 'Brittanys';
            position: absolute;
            top: 0;
            left: 0;
            color: rgba(200, 168, 118, 0.3);
            text-shadow: none;
            z-index: -1;
            transform: translate(3px, 3px);
        }

        .twenty-second {
            font-family: 'Great Vibes', cursive;
            font-size: 315px;
            font-weight: 400;
            color: #3d2817;
            line-height: 1;
            text-shadow: 
                8px 8px 16px rgba(61, 40, 23, 0.7),
                4px 4px 8px rgba(61, 40, 23, 0.5),
                2px 2px 4px rgba(61, 40, 23, 0.9),
                0 0 30px rgba(139, 115, 85, 0.4);
            transform: rotate(1deg);
            animation: gentleFloat 4s ease-in-out infinite 1s;
            position: relative;
        }

        .twenty-second::before {
            content: '22nd';
            position: absolute;
            top: 0;
            left: 0;
            color: rgba(200, 168, 118, 0.3);
            text-shadow: none;
            z-index: -1;
            transform: translate(3px, 3px);
        }

        .bday {
            font-family: 'Cinzel', serif;
            font-size: 315px;
            color: #3d2817;
            font-weight: 100;
            letter-spacing: 70px;
            text-transform: uppercase;
            text-shadow: 
                10px 10px 20px rgba(61, 40, 23, 0.7),
                5px 5px 10px rgba(61, 40, 23, 0.5),
                2px 2px 5px rgba(61, 40, 23, 0.9),
                0 0 40px rgba(139, 115, 85, 0.5);
            animation: elegantPulse 6s ease-in-out infinite;
            position: relative;
            line-height: 1;
        }

        .bday::before {
            content: 'BDAY';
            position: absolute;
            top: 0;
            left: 0;
            color: rgba(200, 168, 118, 0.2);
            text-shadow: none;
            z-index: -1;
            transform: translate(4px, 4px);
        }

        .elegant-btn {
            background: linear-gradient(135deg, #c9a876 0%, #b8a082 25%, #a08968 50%, #8b7355 75%, #6b4423 100%);
            border: 4px solid #3d2817;
            padding: 35px 85px;
            font-family: 'Playfair Display', serif;
            font-size: 3.5rem;
            font-weight: 700;
            color: #3d2817;
            border-radius: 70px;
            cursor: pointer;
            transition: all 0.4s ease;
            box-shadow: 
                0 18px 45px rgba(61, 40, 23, 0.5),
                inset 0 3px 0 rgba(255, 255, 255, 0.4),
                inset 0 -3px 0 rgba(61, 40, 23, 0.3);
            position: relative;
            overflow: hidden;
            text-shadow: 3px 3px 6px rgba(61, 40, 23, 0.4);
            font-style: italic;
            text-transform: capitalize;
            letter-spacing: 3px;
        }

        .camera-container .elegant-btn {
            padding: 25px 60px;
            font-size: 2.8rem;
        }

        .elegant-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.6s ease;
        }

        .elegant-btn::after {
            display: none;
        }

        @keyframes gentleFloat {
            0%, 100% { transform: rotate(-2deg) translateY(0px); }
            50% { transform: rotate(-2deg) translateY(-8px); }
        }

        @keyframes elegantPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .elegant-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 40px rgba(61, 40, 23, 0.5);
        }

        .elegant-btn:hover::before {
            left: 100%;
        }

        .elegant-btn:active {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(61, 40, 23, 0.3);
        }

        /* Camera Page Styles - Optimized for iPad Mini */
        .camera-container {
            position: relative;
            z-index: 3;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 50px;
            width: 100%;
            height: 100%;
            justify-content: center;
            padding: 40px 0;
        }

        .camera-screen {
            width: 800px;
            height: 600px;
            border: 18px solid #3d2817;
            border-radius: 30px;
            overflow: hidden;
            position: relative;
            background: #000;
            box-shadow: 
                0 20px 50px rgba(61, 40, 23, 0.6),
                inset 0 0 25px rgba(61, 40, 23, 0.3);
        }

        .camera-screen.large {
            width: 1000px;
            height: 750px;
            border: 25px solid #3d2817;
        }

        #video, #captureVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .filter-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 15px 20px;
            justify-content: center;
            max-width: 600px;
        }

        .filter-btn {
            background: linear-gradient(135deg, #b8a082 0%, #a08968 50%, #8b7355 100%);
            border: none;
            padding: 12px 30px;
            font-family: 'Dancing Script', cursive;
            font-size: 1.6rem;
            font-weight: 600;
            color: #3d2817;
            border-radius: 35px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(61, 40, 23, 0.2);
            position: relative;
            overflow: hidden;
        }

        .filter-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.4s;
        }

        .filter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(61, 40, 23, 0.3);
        }

        .filter-btn:hover::before {
            left: 100%;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #d4b895 0%, #c9a876 50%, #b8a082 100%);
            box-shadow: inset 0 3px 10px rgba(61, 40, 23, 0.2);
            transform: translateY(1px);
        }

        .countdown {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 15rem;
            color: white;
            text-shadow: 
                6px 6px 12px rgba(0,0,0,0.9),
                3px 3px 6px rgba(0,0,0,0.7),
                0 0 50px rgba(255,255,255,0.3);
            font-family: 'Cinzel', serif;
            font-weight: 900;
            z-index: 10;
            display: none;
            animation: countdownPulse 1s ease-in-out;
        }

        @keyframes countdownPulse {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .photo-counter {
            font-family: 'Dancing Script', cursive;
            font-size: 2rem;
            font-weight: 600;
            color: #3d2817;
            margin-top: 20px;
        }

        /* Photo Strip Page - iPad Mini Specific Layout (6"√ó4") */
        .strip-container {
            position: relative;
            z-index: 3;
            display: grid;
            grid-template-columns: 2in 4in;
            width: 100vw;
            height: 100vh;
            padding: 0;
            margin: 0;
            box-sizing: border-box;
        }

        .phone-input-container {
            display: flex;
            flex-direction: column;
            gap: 0.3in;
            align-items: center;
            justify-content: center;
            padding: 0.2in;
            background: transparent;
            margin-left: 2.3in;
        }

        .photo-strip {
            width: calc((100% + 3in) * 1.3);
            height: calc((100% + 3in) * 1.3);
            background: #3d2817;
            border-radius: 15px;
            padding: 0;
            position: relative;
            overflow: hidden;
            box-shadow: 0 15px 30px rgba(61, 40, 23, 0.6);
            margin: 0.9in 0 0 0.4in;
            transform: scale(1.56);
            transform-origin: top left;
        }

        .photo-strip::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 1.5in;
            background: url('background.png') center/cover no-repeat;
            opacity: 0.1;
            z-index: 1;
        }

        .photo-strip::after {
            content: '‚òÖ ‚óÜ ‚òÖ ‚óÜ ‚òÖ ‚óÜ ‚òÖ ‚óÜ ‚òÖ ‚óÜ ‚òÖ ‚óÜ ‚òÖ ‚óÜ ‚òÖ';
            position: absolute;
            bottom: 0.05in;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 0.08in;
            color: rgba(139, 115, 85, 0.3);
            z-index: 2;
            letter-spacing: 0.05in;
        }

        .strip-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 0.4in;
            background: url('background.png') center/cover no-repeat;
            opacity: 0.1;
            z-index: 1;
        }

        .strip-bottom-bg {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 1.5in;
            background: yellow;
            opacity: 1;
            z-index: 1;
        }

        .strip-photos {
            display: flex;
            flex-direction: column;
            gap: 0.08in;
            height: 4.2in;
            position: relative;
            z-index: 2;
            margin-top: 0.4in;
            padding: 0 0.15in;
        }

        .strip-photo {
            flex: 1;
            border-radius: 8px;
            overflow: hidden;
            background: #000;
            border: 2px solid #d4b895;
            height: 1.3in;
            max-height: 1.3in;
        }

        .strip-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .strip-title {
            position: absolute;
            bottom: 0.3in;
            left: 0.15in;
            z-index: 10;
            text-align: left;
        }

        .strip-title .brittanys {
            font-family: 'Dancing Script', cursive;
            font-size: 0.4in;
            font-weight: 700;
            color: #d4b895;
            line-height: 0.9;
            margin-bottom: -2px;
            animation: none;
            transform: none;
        }

        .strip-title .twenty-second {
            font-family: 'Dancing Script', cursive;
            font-size: 0.4in;
            font-weight: 600;
            color: #d4b895;
            line-height: 0.9;
            margin-bottom: 2px;
            animation: none;
            transform: none;
        }

        .strip-title .bday {
            font-family: 'Cinzel', serif;
            font-size: 0.4in;
            color: #d4b895;
            font-weight: 800;
            letter-spacing: 2px;
            text-transform: uppercase;
            animation: none;
            transform: none;
        }

        .strip-cowboy {
            position: absolute;
            bottom: 0.15in;
            left: 0.15in;
            right: 0.15in;
            height: 0.25in;
            background: url('cowboy.png') center/contain no-repeat;
            opacity: 0.12;
            z-index: 4;
        }

        .phone-input {
            padding: 0.22in;
            font-size: 0.22in;
            border: 2px solid #3d2817;
            border-radius: 20px;
            background: rgba(212, 184, 149, 0.8);
            width: 3.64in;
            height: 0.6in;
            text-align: center;
            font-family: 'Dancing Script', cursive;
            font-weight: 600;
            color: #3d2817;
        }

        .phone-input::placeholder {
            color: #6b4423;
            font-style: italic;
        }

        .phone-input:focus {
            outline: none;
            border-color: #8b7355;
            background: rgba(212, 184, 149, 1);
            box-shadow: 0 0 8px rgba(61, 40, 23, 0.2);
        }

        .strip-page-btn {
            background: linear-gradient(135deg, #c9a876 0%, #b8a082 25%, #a08968 50%, #8b7355 75%, #6b4423 100%);
            border: 2px solid #3d2817;
            padding: 0.18in 0.21in;
            font-family: 'Playfair Display', serif;
            font-size: 0.18in;
            font-weight: 600;
            color: #3d2817;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(61, 40, 23, 0.3);
            text-transform: capitalize;
            letter-spacing: 1px;
            width: 3.64in;
            height: 0.6in;
        }

        .strip-page-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(61, 40, 23, 0.4);
        }

        .strip-page-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 4px 10px rgba(61, 40, 23, 0.3);
        }

        /* CSS Filters */
        .sepia-filter {
            filter: sepia(1) contrast(1.2) brightness(1.1);
        }

        .vintage-filter {
            filter: sepia(0.8) contrast(1.3) brightness(0.9) hue-rotate(15deg);
        }

        .blackwhite-filter {
            filter: grayscale(1) contrast(1.2) brightness(1.1);
        }

        .desert-filter {
            filter: sepia(0.9) contrast(1.4) brightness(1.2) saturate(1.1) hue-rotate(35deg);
        }

        .sunset-filter {
            filter: sepia(0.7) contrast(1.3) brightness(1.1) saturate(1.4) hue-rotate(10deg);
        }

        .retro-filter {
            filter: contrast(1.5) saturate(1.2) sepia(0.3) hue-rotate(-10deg);
        }

        .lens-flare {
            position: absolute;
            top: 20%;
            left: 30%;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0.4) 30%, transparent 70%);
            border-radius: 50%;
            opacity: 0;
            pointer-events: none;
            z-index: 20;
            animation: lensFlare 0.3s ease-out;
        }

        @keyframes lensFlare {
            0% { 
                opacity: 0; 
                transform: scale(0.3); 
            }
            30% { 
                opacity: 1; 
                transform: scale(1); 
            }
            100% { 
                opacity: 0; 
                transform: scale(1.2); 
            }
        }

        .flash-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            opacity: 0;
            pointer-events: none;
            z-index: 15;
        }

        .flash-overlay.flash {
            animation: flashEffect 0.3s ease-out;
        }

        @keyframes flashEffect {
            0% { opacity: 0; }
            50% { opacity: 0.9; }
            100% { opacity: 0; }
        }

        canvas {
            display: none;
        }

        .status-message {
            padding: 10px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
            font-family: 'Dancing Script', cursive;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .status-success {
            background: rgba(76, 175, 80, 0.2);
            color: #2e7d32;
            border: 2px solid #4caf50;
        }

        .status-error {
            background: rgba(244, 67, 54, 0.2);
            color: #c62828;
            border: 2px solid #f44336;
        }

        .status-info {
            background: rgba(33, 150, 243, 0.2);
            color: #1565c0;
            border: 2px solid #2196f3;
        }

        /* iPad Mini Specific Optimizations */
        @media (max-width: 820px) and (max-height: 1180px) {
            /* iPad Mini Portrait */
            .brittanys { font-size: 235px; }
            .twenty-second { font-size: 235px; }
            .bday { font-size: 235px; letter-spacing: 50px; }
            .camera-screen { width: 650px; height: 450px; }
            .camera-screen.large { width: 750px; height: 550px; }
            .countdown { font-size: 12rem; }
            .elegant-btn { font-size: 3.5rem; padding: 35px 85px; }
        }

        @media (max-width: 1180px) and (max-height: 820px) {
            /* iPad Mini Landscape */
            .brittanys { font-size: 155px; }
            .twenty-second { font-size: 155px; }
            .bday { font-size: 155px; letter-spacing: 35px; }
            .camera-screen { width: 600px; height: 400px; }
            .camera-screen.large { width: 700px; height: 500px; }
            .countdown { font-size: 10rem; }
            .elegant-btn { font-size: 3rem; padding: 30px 70px; }
            .strip-container { flex-direction: row; gap: 50px; }
        }

        /* General Responsive Design */
        @media (max-width: 1024px) {
            .brittanys { font-size: 215px; }
            .twenty-second { font-size: 215px; }
            .bday { font-size: 215px; letter-spacing: 45px; }
            .camera-screen { width: 600px; height: 420px; }
            .camera-screen.large { width: 750px; height: 550px; }
            .countdown { font-size: 12rem; }
            .elegant-btn { font-size: 3.5rem; padding: 35px 85px; }
            .filter-btn { font-size: 1.8rem; padding: 15px 35px; }
        }

        @media (max-width: 768px) {
            .brittanys { font-size: 135px; }
            .twenty-second { font-size: 135px; }
            .bday { font-size: 135px; letter-spacing: 30px; }
            .camera-screen { width: 500px; height: 350px; }
            .camera-screen.large { width: 600px; height: 450px; }
            .countdown { font-size: 10rem; }
            .elegant-btn { font-size: 3rem; padding: 30px 65px; }
            .strip-container { flex-direction: column; gap: 40px; }
            .photo-strip { width: 200px; height: 600px; }
        }
    </style>
</head>
<body>
    <!-- Start Page -->
    <div class="page active" id="startPage">
        <div class="background">
            <div class="cowboy-bg"></div>
        </div>
        <div class="main-content">
            <div class="title">
                <div class="brittanys">Brittanys</div>
                <div class="twenty-second">22nd</div>
                <div class="bday">BDAY</div>
            </div>
            <button class="elegant-btn" onclick="startPhotoSession()">Start</button>
        </div>
        <div class="flash-overlay" id="flashOverlay"></div>
    </div>

    <!-- Filter Selection Page -->
    <div class="page" id="filterPage">
        <div class="background">
            <div class="cowboy-bg"></div>
        </div>
        <div class="camera-container">
            <div class="camera-screen">
                <video id="video" autoplay muted playsinline></video>
            </div>
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="setFilter('none')">No Filter</button>
                <button class="filter-btn" onclick="setFilter('blackwhite')">Black & White</button>
                <button class="filter-btn" onclick="setFilter('vintage')">Vintage</button>
                <button class="filter-btn" onclick="setFilter('desert')">Desert</button>
                <button class="filter-btn" onclick="setFilter('sunset')">Sunset</button>
                <button class="filter-btn" onclick="setFilter('retro')">Retro</button>
            </div>
            <button class="elegant-btn" onclick="startCountdown()">Continue</button>
        </div>
        <div class="flash-overlay"></div>
    </div>

    <!-- Photo Capture Page -->
    <div class="page" id="capturePage">
        <div class="background">
            <div class="cowboy-bg"></div>
        </div>
        <div class="camera-container">
            <div class="camera-screen large">
                <video id="captureVideo" autoplay muted playsinline></video>
                <div class="countdown" id="countdown">3</div>
            </div>
            <div class="photo-counter" id="photoCounter">Photo 1 of 3</div>
        </div>
        <div class="flash-overlay"></div>
    </div>

    <!-- Photo Strip Page -->
    <div class="page" id="stripPage">
        <div class="background">
            <div class="cowboy-bg"></div>
        </div>
        <div class="strip-container">
            <div class="photo-strip">
                <div class="strip-title">
                    <div class="brittanys">Brittanys</div>
                    <div class="twenty-second">22nd</div>
                    <div class="bday">BDAY</div>
                </div>
                <div class="strip-photos">
                    <div class="strip-photo" id="stripPhoto1"></div>
                    <div class="strip-photo" id="stripPhoto2"></div>
                    <div class="strip-photo" id="stripPhoto3"></div>
                </div>
            </div>
            <div class="phone-input-container">
                <div style="text-align: center; margin-bottom: 0.15in; color: #3d2817; font-family: 'Dancing Script', cursive; font-size: 0.16in; font-weight: 600;">
                    Get your photo strip via email!
                </div>
                <input type="email" class="phone-input" id="emailInput" placeholder="Enter your email address">
                <div id="statusMessage"></div>
                <button class="strip-page-btn" onclick="sendPhotoStrip()">Email My Photos</button>
                <button class="strip-page-btn" onclick="testFunction()">üîß Test Function</button>
                <button class="strip-page-btn" onclick="simpleEmailTest()">üìß Simple Email Test</button>
                <button class="strip-page-btn" onclick="restartSession()">Take New Photos</button>
            </div>
        </div>
        <div class="flash-overlay"></div>
    </div>

    <canvas id="canvas"></canvas>

    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script type="text/javascript">
        // Initialize EmailJS with your public key
        (function() {
            emailjs.init({
                publicKey: "o9F_uYO6T0n9C7ngK",
            });
        })();
    </script>

    <script>
        let currentFilter = 'none';
        let capturedPhotos = [];
        let photoCount = 0;
        let stream = null;

        // Audio elements
        const beepSound = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmgfCjiZ3+6+diMFpgAAAA==');
        const cameraSound = new Audio('data:audio/wav;base64,UklGRnIGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU4GAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmgfCjiZ3+6+diMFpgAAA==');

        // Status message helper function
        function showStatusMessage(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = `status-message status-${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        async function startPhotoSession() {
            document.getElementById('startPage').classList.remove('active');
            document.getElementById('filterPage').classList.add('active');
            
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: 1920, 
                        height: 1080,
                        facingMode: 'user'
                    } 
                });
                document.getElementById('video').srcObject = stream;
                document.getElementById('captureVideo').srcObject = stream;
            } catch (error) {
                console.error('Error accessing camera:', error);
                alert('Unable to access camera. Please ensure camera permissions are granted.');
            }
        }

        function setFilter(filterType) {
            currentFilter = filterType;
            const video = document.getElementById('video');
            const captureVideo = document.getElementById('captureVideo');
            
            // Remove all filter classes
            video.className = '';
            captureVideo.className = '';
            
            // Add selected filter
            if (filterType !== 'none') {
                video.classList.add(filterType + '-filter');
                captureVideo.classList.add(filterType + '-filter');
            }
            
            // Update button states
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function startCountdown() {
            document.getElementById('filterPage').classList.remove('active');
            document.getElementById('capturePage').classList.add('active');
            
            photoCount = 0;
            capturedPhotos = [];
            takeNextPhoto();
        }

        function takeNextPhoto() {
            photoCount++;
            document.getElementById('photoCounter').textContent = `Photo ${photoCount} of 3`;
            
            let countdownNum = 3;
            const countdownEl = document.getElementById('countdown');
            countdownEl.style.display = 'block';
            countdownEl.textContent = countdownNum;
            
            const countdownInterval = setInterval(() => {
                beepSound.currentTime = 0;
                beepSound.play().catch(e => console.log('Audio play failed:', e));
                
                countdownNum--;
                if (countdownNum > 0) {
                    countdownEl.textContent = countdownNum;
                } else {
                    clearInterval(countdownInterval);
                    countdownEl.style.display = 'none';
                    capturePhoto();
                }
            }, 1000);
        }

        function capturePhoto() {
            const video = document.getElementById('captureVideo');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Apply filter to canvas
            if (currentFilter !== 'none') {
                ctx.filter = getCanvasFilter(currentFilter);
            }
            
            ctx.drawImage(video, 0, 0);
            
            // Immediate lens flare effect
            const lensFlare = document.createElement('div');
            lensFlare.className = 'lens-flare';
            document.querySelector('#capturePage .camera-screen').appendChild(lensFlare);
            setTimeout(() => lensFlare.remove(), 300);
            
            // Flash effect
            const flashOverlay = document.querySelector('#capturePage .flash-overlay');
            flashOverlay.classList.add('flash');
            setTimeout(() => flashOverlay.classList.remove('flash'), 300);
            
            // Camera sound
            cameraSound.currentTime = 0;
            cameraSound.play().catch(e => console.log('Audio play failed:', e));
            
            // Store photo with filter info
            const photoData = canvas.toDataURL('image/jpeg', 0.9);
            capturedPhotos.push({
                data: photoData,
                filter: currentFilter
            });
            
            if (photoCount < 3) {
                setTimeout(() => takeNextPhoto(), 1500);
            } else {
                setTimeout(() => showPhotoStrip(), 3000);
            }
        }

        function getCanvasFilter(filterType) {
            switch(filterType) {
                case 'sepia':
                    return 'sepia(1) contrast(1.2) brightness(1.1)';
                case 'vintage':
                    return 'sepia(0.8) contrast(1.3) brightness(0.9) hue-rotate(15deg)';
                case 'blackwhite':
                    return 'grayscale(1) contrast(1.2) brightness(1.1)';
                case 'desert':
                    return 'sepia(0.9) contrast(1.4) brightness(1.2) saturate(1.1) hue-rotate(35deg)';
                case 'sunset':
                    return 'sepia(0.7) contrast(1.3) brightness(1.1) saturate(1.4) hue-rotate(10deg)';
                case 'retro':
                    return 'contrast(1.5) saturate(1.2) sepia(0.3) hue-rotate(-10deg)';
                default:
                    return 'none';
            }
        }

        function showPhotoStrip() {
            document.getElementById('capturePage').classList.remove('active');
            document.getElementById('stripPage').classList.add('active');
            
            // Display photos in strip with applied filters
            for (let i = 0; i < 3; i++) {
                const stripPhoto = document.getElementById(`stripPhoto${i + 1}`);
                const img = document.createElement('img');
                img.src = capturedPhotos[i].data;
                
                // Apply the same filter that was used during capture
                if (capturedPhotos[i].filter !== 'none') {
                    img.classList.add(capturedPhotos[i].filter + '-filter');
                }
                
                stripPhoto.innerHTML = '';
                stripPhoto.appendChild(img);
            }
            
            // Stop camera stream
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        }

        // Enhanced email function with EmailJS integration
        async function sendPhotoStrip() {
            const emailInput = document.getElementById('emailInput');
            const email = emailInput.value.trim();
            
            // Validate email
            if (!email) {
                showStatusMessage('Please enter an email address', 'error');
                return;
            }
            
            // Basic email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showStatusMessage('Please enter a valid email address', 'error');
                return;
            }
            
            // Check if photos exist
            if (!capturedPhotos || capturedPhotos.length === 0) {
                showStatusMessage('No photos to send. Take some photos first!', 'error');
                return;
            }
            
            // Disable button while sending
            const button = event.target;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'Sending...';
            
            showStatusMessage('Capturing photo strip and sending email...', 'info');
            
            try {
                // Capture the exact photo strip as displayed
                const photoStripDataURL = await capturePhotoStripAsDisplayed();
                
                // Prepare email template parameters
                const templateParams = {
                    to_email: email,
                    to_name: email.split('@')[0], // Use part before @ as name
                    from_name: "Brittany's 22nd Birthday Party",
                    subject: "üéâ Your Photo Booth Pictures from Brittany's 22nd Birthday!",
                    message: `Hi there!\n\nThanks for celebrating Brittany's 22nd birthday with us! üéÇ\n\nAttached is your photo booth strip from the party, exactly as it appeared on screen! We hope you had as much fun taking these pictures as we did setting up the booth!\n\nKeep celebrating! ü•≥\n\n- Brittany's Birthday Team`,
                    photo_strip: photoStripDataURL,
                    photo1: capturedPhotos[0]?.data || '',
                    photo2: capturedPhotos[1]?.data || '',
                    photo3: capturedPhotos[2]?.data || ''
                };

                // Send email using EmailJS
                const result = await emailjs.send(
                    'service_9n5lgms',      // Your service ID
                    'template_js58xgg',     // Your template ID
                    templateParams
                );

                console.log('Email sent successfully:', result);
                showStatusMessage(`üéâ Photo strip successfully sent to ${email}! Check your inbox!`, 'success');
                
                // Clear email input on success
                emailInput.value = '';
                
            } catch (error) {
                console.error('Email sending failed:', error);
                showStatusMessage('Failed to send email. Please try again or check your internet connection.', 'error');
            } finally {
                // Re-enable button
                button.disabled = false;
                button.textContent = originalText;
            }
        }

        // Simplified and more reliable photo strip capture
        async function capturePhotoStripAsDisplayed() {
            return new Promise((resolve, reject) => {
                try {
                    console.log('üîß DEBUG: Starting photo strip capture...');
                    
                    // Create canvas for the photo strip
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Set canvas dimensions (similar to the display strip but optimized for email)
                    canvas.width = 400;  // 2 inches at 200 DPI
                    canvas.height = 1200; // 6 inches at 200 DPI
                    
                    // Fill background
                    ctx.fillStyle = '#3d2817';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // Add rounded corners effect
                    ctx.globalCompositeOperation = 'destination-out';
                    const cornerRadius = 15;
                    ctx.beginPath();
                    ctx.moveTo(0, 0);
                    ctx.lineTo(cornerRadius, 0);
                    ctx.quadraticCurveTo(0, 0, 0, cornerRadius);
                    ctx.closePath();
                    ctx.fill();
                    
                    // Reset composite operation
                    ctx.globalCompositeOperation = 'source-over';
                    
                    // Draw title section
                    ctx.fillStyle = '#d4b895';
                    ctx.textAlign = 'left';
                    
                    // "Brittanys" in Dancing Script style
                    ctx.font = 'italic bold 32px serif';
                    ctx.fillText("Brittanys", 30, 980);
                    
                    // "22nd" 
                    ctx.font = 'italic bold 30px serif';
                    ctx.fillText("22nd", 30, 1020);
                    
                    // "BDAY"
                    ctx.font = 'bold 28px serif';
                    ctx.fillText("BDAY", 30, 1060);
                    
                    // Add decorative stars at bottom
                    ctx.fillStyle = 'rgba(139, 115, 85, 0.3)';
                    ctx.font = '14px serif';
                    ctx.textAlign = 'center';
                    ctx.fillText('‚òÖ ‚óÜ ‚òÖ ‚óÜ ‚òÖ ‚óÜ ‚òÖ ‚óÜ ‚òÖ ‚óÜ ‚òÖ ‚óÜ ‚òÖ ‚óÜ ‚òÖ', canvas.width / 2, 1180);
                    
                    // Draw photos
                    if (!capturedPhotos || capturedPhotos.length === 0) {
                        console.log('üîß DEBUG: No photos to draw, returning strip with text only');
                        resolve(canvas.toDataURL('image/jpeg', 0.9));
                        return;
                    }
                    
                    let photosProcessed = 0;
                    const photoWidth = canvas.width - 60; // 30px margin on each side
                    const photoHeight = 280; // Fixed height for each photo
                    const startY = 50;
                    const photoSpacing = 20;
                    
                    console.log('üîß DEBUG: Processing', capturedPhotos.length, 'photos');
                    
                    capturedPhotos.forEach((photo, index) => {
                        const img = new Image();
                        img.onload = () => {
                            const y = startY + (index * (photoHeight + photoSpacing));
                            
                            // Draw photo border
                            ctx.fillStyle = '#d4b895';
                            ctx.fillRect(27, y - 3, photoWidth + 6, photoHeight + 6);
                            
                            // Draw the photo
                            ctx.drawImage(img, 30, y, photoWidth, photoHeight);
                            
                            photosProcessed++;
                            console.log('üîß DEBUG: Processed photo', index + 1, 'of', capturedPhotos.length);
                            
                            if (photosProcessed === capturedPhotos.length) {
                                console.log('üîß DEBUG: All photos processed, generating final image');
                                resolve(canvas.toDataURL('image/jpeg', 0.9));
                            }
                        };
                        
                        img.onerror = (error) => {
                            console.error('üîß DEBUG: Failed to load photo', index + 1, error);
                            photosProcessed++;
                            
                            if (photosProcessed === capturedPhotos.length) {
                                resolve(canvas.toDataURL('image/jpeg', 0.9));
                            }
                        };
                        
                        // Set the image source
                        img.src = photo.data;
                    });
                    
                } catch (error) {
                    console.error('üîß DEBUG: Photo strip capture failed:', error);
                    reject(error);
                }
            });
        }

        // Test function for debugging
        function testFunction() {
            console.log('Test function called!');
            console.log('Current photos:', capturedPhotos.length);
            console.log('Current filter:', currentFilter);
            
            showStatusMessage('Test function executed! Check browser console for details.', 'info');
            
            // Test email validation
            const emailInput = document.getElementById('emailInput');
            if (emailInput.value) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                const isValid = emailRegex.test(emailInput.value.trim());
                showStatusMessage(`Email validation: ${isValid ? 'Valid' : 'Invalid'}`, isValid ? 'success' : 'error');
            }
        }

        function restartSession() {
            document.getElementById('stripPage').classList.remove('active');
            document.getElementById('startPage').classList.add('active');
            
            // Reset everything
            capturedPhotos = [];
            photoCount = 0;
            currentFilter = 'none';
            document.getElementById('emailInput').value = '';
            document.getElementById('statusMessage').style.display = 'none';
            
            // Reset filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.filter-btn').classList.add('active');
        }

        // Handle page visibility changes to pause/resume camera
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });

        // Simple email test without photo strip
        async function simpleEmailTest() {
            const emailInput = document.getElementById('emailInput');
            const email = emailInput.value.trim();
            
            if (!email) {
                showStatusMessage('Enter an email address first!', 'error');
                return;
            }

            if (typeof emailjs === 'undefined') {
                showStatusMessage('‚ùå EmailJS not loaded!', 'error');
                return;
            }

            console.log('üîß SIMPLE TEST: Attempting basic email send...');
            
            try {
                const result = await emailjs.send(
                    'service_9n5lgms',
                    'template_js58xgg',
                    {
                        to_email: email,
                        to_name: 'Test User',
                        from_name: 'Photo Booth Test',
                        subject: 'Test Email',
                        message: 'This is a test email to verify EmailJS is working.',
                        photo_strip: 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAABAAEDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAv/xAAUEAEAAAAAAAAAAAAAAAAAAAAA/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAX/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwCdABmX/9k=',
                        photo1: '',
                        photo2: '',
                        photo3: ''
                    }
                );
                
                console.log('‚úÖ Simple email test successful:', result);
                showStatusMessage('‚úÖ Simple email test successful! Check your inbox.', 'success');
                
            } catch (error) {
                console.error('‚ùå Simple email test failed:', error);
                showStatusMessage(`‚ùå Simple email failed: ${error.text || error.message}`, 'error');
            }
        }

        // Make functions available globally for onclick handlers
        window.sendPhotoStrip = sendPhotoStrip;
        window.testFunction = testFunction;
        window.simpleEmailTest = simpleEmailTest;
    </script>
</body>
</html>
